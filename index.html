<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Facturaci√≥n ‚Äì UI + Login + CFDI</title>
<link rel="icon" href="data:,">
<style>
:root{ --primary:#e11; --dark:#111; --muted:#f6f7fb; --border:#e5e7eb }
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
body{margin:0;background:var(--muted);color:#222}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
.bar{max-width:1200px;margin:auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
h1{font-size:20px;margin:0;font-weight:800;color:#1f2937}
nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
nav button{border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
nav button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
main{max-width:1200px;margin:20px auto;padding:0 16px}
.card{background:#fff;border:1px solid var(--border);border-radius:18px;padding:18px;margin:12px 0;box-shadow:0 2px 10px rgba(17,17,17,.06)}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
label{font-size:12px;font-weight:800;color:#374151;margin-bottom:6px;display:block}
input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:14px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}.btn-outline{background:#fff;border:1px solid var(--border);font-weight:800}
.table{width:100%;border-collapse:collapse}.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
.badge{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px}
.split{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
.hint{font-size:12px;color:#666}
@media (max-width:980px){.row{grid-template-columns:repeat(6,1fr)}.col-6{grid-column:span 6}.col-4{grid-column:span 6}.col-3{grid-column:span 3}.split{grid-template-columns:1fr}}
</style>
</head>
<body>
<header><div class="bar">
  <h1>üíº Facturaci√≥n (UI + Login + CFDI)</h1>
  <span class="badge">Compra ‚Üí Facturar ‚Üí Reporte ‚Üí CFDI</span>
  <nav>
    <button id="tab-compra" class="active" onclick="showTab('compra')">Compra</button>
    <button id="tab-facturacion" onclick="showTab('facturacion')">Facturaci√≥n</button>
    <button id="tab-reportes" onclick="showTab('reportes')">Reportes</button>
    <button id="tab-sesion" onclick="showTab('sesion')">Sesi√≥n</button>
  </nav>
</div></header>
<main>

<section id="sesion" class="tab" style="display:none">
  <div class="card">
    <h2>üîê Sesi√≥n</h2>
    <div class="row">
      <div class="col-6"><label>API Base</label><input id="apiBase" placeholder="http://localhost:4000/api"/></div>
      <div class="col-6"><label>Token (si ya tienes uno)</label><input id="apiToken" placeholder="pegar token aqu√≠"/></div>
      <div class="col-6"><label>Email</label><input id="loginEmail" placeholder="admin@demo.com"/></div>
      <div class="col-6"><label>Contrase√±a</label><input id="loginPass" type="password" placeholder="cualquiera"/></div>
      <div class="col-12 actions right">
        <button class="btn btn-outline" onclick="seed()">Crear usuario demo</button>
        <button class="btn btn-primary" onclick="login()">Iniciar sesi√≥n</button>
      </div>
      <p class="hint">El backend acepta cualquier contrase√±a para el usuario demo.</p>
    </div>
    <div id="sesionEstado" class="hint"></div>
  </div>
</section>

<section id="compra" class="tab">
  <div class="split">
    <form id="formCompra" class="card" onsubmit="guardarCompra(event)">
      <h2>üßæ Registrar compra de servicio</h2>
      <div class="row">
        <div class="col-6"><label>Proveedor</label><input required name="proveedor"/></div>
        <div class="col-3"><label>N¬∫ de orden</label><input name="orden"/></div>
        <div class="col-3"><label>Fecha</label><input type="date" required name="fecha"/></div>
        <div class="col-4"><label>Costo</label><input type="number" step="0.01" required name="costo"/></div>
        <div class="col-4"><label>Forma de pago</label><select name="formaPago"><option>Tarjeta</option><option>Transferencia</option><option>Efectivo</option></select></div>
        <div class="col-4"><label>√öltimos 4</label><input name="ult4" maxlength="4"/></div>
        <div class="col-6"><label>Socio</label><input name="socio"/></div>
        <div class="col-6"><label>Concepto</label><input name="concepto"/></div>
        <div class="col-12 actions right"><button class="btn btn-outline" type="reset">Limpiar</button><button class="btn btn-primary" type="submit">Guardar compra</button></div>
      </div>
    </form>
    <div class="card">
      <h3 style="margin:0">üìö Compras registradas</h3>
      <div class="row"><div class="col-6"><label>Buscar</label><input id="buscaCompra" oninput="renderCompras()" placeholder="Proveedor, orden..."/></div>
      <div class="col-6 actions right"><button class="btn btn-outline" onclick="exportarCSV('compras')">Exportar CSV</button></div></div>
      <div style="overflow:auto"><table class="table" id="tablaCompras"></table></div>
    </div>
  </div>
</section>

<section id="facturacion" class="tab" style="display:none">
  <div class="split">
    <form id="formFactura" class="card" onsubmit="emitirFactura(event)">
      <h2>üßÆ Emitir factura al cliente</h2>
      <div class="row">
        <div class="col-6"><label>Desde compra</label><select id="linkCompra" onchange="prefillDesdeCompra(this.value)"></select></div>
        <div class="col-6"><label>Concepto</label><input required name="concepto"/></div>
        <div class="col-3"><label>Costo</label><input type="number" step="0.01" name="costo"/></div>
        <div class="col-3"><label>Margen %</label><input type="number" step="0.01" name="margen" value="20"/></div>
        <div class="col-3"><label>Precio final</label><input type="number" step="0.01" name="precioFinal"/></div>
        <div class="col-3"><label>Fecha emisi√≥n</label><input type="date" name="fechaEmision"/></div>
        <div class="col-4"><label>RFC</label><input name="rfc"/></div>
        <div class="col-8"><label>Raz√≥n social</label><input name="razon"/></div>
        <div class="col-12 actions right"><button class="btn btn-outline" type="button" onclick="calcularPrecioFinal()">Calcular</button><button class="btn btn-primary" type="submit">Guardar (demo)</button></div>
      </div>
    </form>

    <div class="card">
      <h3 style="margin:0">üì§ Importar CFDI (XML+PDF) ‚Üí Crear factura</h3>
      <div class="row">
        <div class="col-6"><label>XML</label><input id="xmlFile" type="file" accept=".xml"/></div>
        <div class="col-6"><label>PDF (opcional)</label><input id="pdfFile" type="file" accept=".pdf"/></div>
        <div class="col-12 actions right"><button class="btn btn-primary" type="button" onclick="subirCFDI()">Subir CFDI e integrar</button></div>
      </div>
      <div id="cfdiPreview" class="card" style="display:none"></div>
    </div>
  </div>

  <div class="card">
    <h3>üóÇÔ∏è Facturas emitidas</h3>
    <div class="row">
      <div class="col-6"><label>Buscar</label><input id="buscaFactura" oninput="renderFacturas()" placeholder="RFC, raz√≥n, concepto..."/></div>
      <div class="col-6 actions right"><button class="btn btn-outline" onclick="exportarCSV('facturas')">Exportar CSV</button></div>
    </div>
    <div style="overflow:auto"><table class="table" id="tablaFacturas"></table></div>
  </div>
</section>

<section id="reportes" class="tab" style="display:none">
  <div class="card">
    <h2>üìà Reporte y conciliaci√≥n</h2>
    <div class="row">
      <div class="col-4"><label>Desde</label><input type="date" id="rDesde"/></div>
      <div class="col-4"><label>Hasta</label><input type="date" id="rHasta"/></div>
      <div class="col-4 actions right"><button class="btn btn-outline" onclick="renderReporte()">Actualizar</button><button class="btn btn-outline" onclick="exportarCSV('reporte')">Exportar CSV</button></div>
    </div>
    <div class="totals" style="display:flex;gap:20px;flex-wrap:wrap;margin:12px 0">
      <div class="card" style="min-width:190px"><div class="hint">Total facturado</div><div id="kpiFacturado" style="font-weight:800;font-size:22px">$0</div></div>
    </div>
  </div>
</section>

</main>
<script>
const $$=(s,r=document)=>r.querySelector(s);const $$$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const money=n=>new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(Number(n||0));
const todayISO=()=>new Date().toISOString().slice(0,10);
const LS={compras:'fact_demo_compras',facturas:'fact_demo_facturas',apiBase:'fact_api_base',token:'fact_token'};
const load=k=>JSON.parse(localStorage.getItem(k)||'[]');const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=>Math.random().toString(36).slice(2,9);

// Sesi√≥n
function setEstado(msg){$$('#sesionEstado').textContent=msg||'';}
function apiBase(){return (localStorage.getItem(LS.apiBase)||'').replace(/\/$/,'')||'http://localhost:4000/api'}
function token(){return localStorage.getItem(LS.token)||''}
async function seed(){
  const base=$$('#apiBase').value||apiBase(); try{
    const r=await fetch(base+'/auth/seed',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:$$('#loginEmail').value||'admin@demo.com',full_name:'Admin',role_name:'Admin'})});
    if(!r.ok){setEstado('Seed: '+(await r.text()));return;} setEstado('Usuario demo creado (o ya exist√≠a).');
  }catch(e){setEstado('Error seed: '+e.message);}
}
async function login(){
  const base=$$('#apiBase').value||apiBase(); localStorage.setItem(LS.apiBase, base);
  try{
    const r=await fetch(base+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:$$('#loginEmail').value||'admin@demo.com',password:$$('#loginPass').value||'x'})});
    if(!r.ok){setEstado('Login: '+(await r.text()));return;}
    const j=await r.json(); localStorage.setItem(LS.token, j.token); $$('#apiToken').value=j.token; setEstado('Login OK');
  }catch(e){setEstado('Error login: '+e.message);}
}

// Compras (demo local)
function guardarCompra(e){e.preventDefault();const fd=new FormData(e.target);
 const c={id:uid(),proveedor:fd.get('proveedor')?.trim(),orden:fd.get('orden')?.trim(),fecha:fd.get('fecha')||todayISO(),costo:Number(fd.get('costo')||0),formaPago:fd.get('formaPago'),ult4:fd.get('ult4')?.trim(),socio:fd.get('socio')?.trim(),concepto:fd.get('concepto')?.trim(),facturado:false};
 const xs=load(LS.compras);xs.unshift(c);save(LS.compras,xs);e.target.reset();renderCompras();syncSelectorCompras();alert('Compra guardada');}
function renderCompras(){const q=$$('#buscaCompra')?.value?.toLowerCase()||'';const xs=load(LS.compras).filter(c=>[c.proveedor,c.orden,c.concepto,c.socio].some(x=>(x||'').toLowerCase().includes(q)));
 const t=$$('#tablaCompras'); if(!t) return; t.innerHTML=`<thead><tr><th>Fecha</th><th>Proveedor</th><th>Orden</th><th>Concepto</th><th>Costo</th><th>Pago</th><th>Socio</th><th>Estado</th></tr></thead>
 <tbody>${xs.map(c=>`<tr><td>${c.fecha}</td><td>${c.proveedor}</td><td>${c.orden||''}</td><td>${c.concepto||''}</td><td>${money(c.costo)}</td><td>${c.formaPago}${c.ult4?` ‚Ä¢ ${c.ult4}`:''}</td><td>${c.socio||''}</td><td>${c.facturado?'‚úîÔ∏è':'‚è≥'}</td></tr>`).join('')}</tbody>`;}
function enviarAFacturar(id){showTab('facturacion');$$('#linkCompra').value=id;prefillDesdeCompra(id);}
function toggleFacturado(id){const xs=load(LS.compras);const c=xs.find(x=>x.id===id);if(c){c.facturado=!c.facturado;save(LS.compras,xs);renderCompras();renderReporte();}}
function syncSelectorCompras(){const sel=$$('#linkCompra'); if(!sel) return; const xs=load(LS.compras); sel.innerHTML=`<option value="">‚Äî Selecciona una compra ‚Äî</option>`+xs.map(c=>`<option value="${c.id}">${c.fecha} ‚Ä¢ ${c.proveedor} ‚Ä¢ ${c.concepto||''}</option>`).join('');}

// Facturaci√≥n manual (demo local)
function prefillDesdeCompra(id){const f=$$('#formFactura');if(!id){f.reset();return;}const c=load(LS.compras).find(x=>x.id===id);if(!c) return;f.concepto.value=c.concepto||`Servicio de ${c.proveedor}`;f.costo.value=c.costo||0;f.margen.value=20;calcularPrecioFinal();f.fechaEmision.value=todayISO();}
function calcularPrecioFinal(){const f=$$('#formFactura');const costo=Number(f.costo.value||0);const margen=Number(f.margen.value||0);f.precioFinal.value=(costo*(1+margen/100)).toFixed(2);}
function emitirFactura(e){e.preventDefault();const f=e.target;const fd=new FormData(f);
 const fac={id:uid(),compraId:$$('#linkCompra').value||null,concepto:fd.get('concepto')?.trim(),costo:Number(fd.get('costo')||0),margen:Number(fd.get('margen')||0),precioFinal:Number(fd.get('precioFinal')||0),fechaEmision:fd.get('fechaEmision')||todayISO(),rfc:(fd.get('rfc')||'').toUpperCase(),razon:fd.get('razon')?.trim()};
 const xs=load(LS.facturas);xs.unshift(fac);save(LS.facturas,xs);renderFacturas();renderReporte();alert('Factura guardada (demo).');}

// CFDI ‚Üí backend full
async function subirCFDI(){
 const base=( $$('#apiBase').value || apiBase() ).replace(/\/$/,''); const tok = $$('#apiToken').value || token();
 if(!tok){alert('Inicia sesi√≥n o pega el token.'); showTab('sesion'); return;}
 const xml=$$('#xmlFile').files[0];const pdf=$$('#pdfFile').files[0]; if(!xml){alert('Selecciona un XML');return;}
 const fd=new FormData();fd.append('xml',xml);if(pdf) fd.append('pdf',pdf);
 const r=await fetch(base+'/facturas/cargar',{method:'POST',headers:{'Authorization':'Bearer '+tok},body:fd});
 if(r.status===409){const j=await r.json();alert('Ya existe ese UUID: '+j.uuid);return;}
 if(!r.ok){alert('Error '+r.status+': '+(await r.text()));return;}
 const data=await r.json();
 const fac={id:data.id||uid(),compraId:null,concepto:'SERVICIO',costo:data.totales?.subtotal||0,margen:0,precioFinal:data.totales?.total||0,fechaEmision:data.fecha||todayISO(),rfc:data.emisor?.rfc||'',razon:data.receptor?.nombre||''};
 const xs=load(LS.facturas);xs.unshift(fac);save(LS.facturas,xs);renderFacturas();renderReporte();
 const box=$$('#cfdiPreview');box.style.display='block';box.innerHTML=`<h4 style="margin-top:0">CFDI importado</h4>
 <p><b>UUID:</b> ${data.uuid||'(s/n)'} ‚Ä¢ <b>Fecha:</b> ${data.fecha||''}</p>
 <p><b>Emisor:</b> ${data.emisor?.nombre||''} (${data.emisor?.rfc||''})</p>
 <p><b>Receptor:</b> ${data.receptor?.nombre||''} (${data.receptor?.rfc||''})</p>
 <p><b>Totales:</b> ${money(data.totales?.subtotal||0)} ‚Üí ${money(data.totales?.total||0)}</p>
 <div class="actions"><a class="btn btn-outline" target="_blank" href="${data.archivos?.xml||'#'}">XML</a> ${data.archivos?.pdf?`<a class="btn btn-outline" target="_blank" href="${data.archivos.pdf}">PDF</a>`:''}</div>`;
}

// Reporte (usa backend para total timbrado)
async function renderReporte(){
 const base=(localStorage.getItem(LS.apiBase)||'http://localhost:4000/api').replace(/\/$/,''); const tok=token();
 try{const r=await fetch(base+'/reportes/kpis',{headers: tok?{'Authorization':'Bearer '+tok}:{}}); if(r.ok){const j=await r.json(); $$('#kpiFacturado').textContent=money(j.totalFacturado||0);}}
 catch(e){/* ignore offline */}
}

// Facturas render (local demo)
function renderFacturas(){const q=$$('#buscaFactura')?.value?.toLowerCase()||'';const xs=load(LS.facturas).filter(x=>[x.rfc,x.razon,x.concepto].some(v=>(v||'').toLowerCase().includes(q)));
 const t=$$('#tablaFacturas'); if(!t) return; t.innerHTML=`<thead><tr><th>Fecha</th><th>RFC</th><th>Cliente</th><th>Concepto</th><th>Subtotal</th><th>Total</th></tr></thead>
 <tbody>${xs.map(f=>`<tr><td>${f.fechaEmision}</td><td>${f.rfc||''}</td><td>${f.razon||''}</td><td>${f.concepto||''}</td><td>${money(f.costo)}</td><td>${money(f.precioFinal)}</td></tr>`).join('')}</tbody>`;}
function exportarCSV(tipo){let data=[];if(tipo==='compras')data=load(LS.compras);if(tipo==='facturas')data=load(LS.facturas);
 const csv=[Object.keys(data[0]||{})].concat(data.map(obj=>Object.values(obj))).map(r=>r.map(x=>`"${(x??'').toString().replaceAll('"','""')}"`).join(',')).join('\n');const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${tipo}.csv`;a.click();}
function showTab(id){['compra','facturacion','reportes','sesion'].forEach(t=>{$$('#'+t).style.display=(t===id)?'block':'none';$$('#tab-'+t)?.classList.toggle('active',t===id);});localStorage.setItem('fact_demo_tab',id);}
(function init(){ const base=localStorage.getItem(LS.apiBase)||''; if(base) $$('#apiBase').value=base; const t=token(); if(t) $$('#apiToken').value=t; renderCompras(); syncSelectorCompras(); renderFacturas(); renderReporte(); const saved=localStorage.getItem('fact_demo_tab')||'compra'; showTab(saved); })();
</script>
</body>
</html>
